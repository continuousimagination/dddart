# Event Registry Generator

The event registry generator automatically creates a map of event type names to their `fromJson` factory functions, enabling automatic deserialization of distributed events in the EventBusClient.

## Overview

When building distributed event systems, clients need to deserialize events received from the server. The event registry generator scans your codebase for `@Serializable` DomainEvent subclasses and generates a registry map that the EventBusClient can use for automatic deserialization.

## Usage

### 1. Annotate Your Events

Add the `@Serializable` annotation to your DomainEvent subclasses:

```dart
import 'package:dddart/dddart.dart';
import 'package:dddart_serialization/dddart_serialization.dart';

part 'my_events.g.dart';

@Serializable()
class UserCreatedEvent extends DomainEvent {
  UserCreatedEvent({
    required super.aggregateId,
    required this.email,
    required this.name,
  });

  final String email;
  final String name;

  static UserCreatedEvent fromJson(Map<String, dynamic> json) {
    return UserCreatedEvent(
      aggregateId: UuidValue.fromString(json['aggregateId'] as String),
      email: json['email'] as String,
      name: json['name'] as String,
    );
  }
}
```

### 2. Configure build.yaml

Create or update `build.yaml` in your package root:

```yaml
targets:
  $default:
    builders:
      dddart_events_distributed:event_registry:
        enabled: true
```

### 3. Run the Generator

```bash
dart run build_runner build
```

### 4. Generated Output

The generator creates a file with the `.event_registry.g.dart` extension containing:

```dart
// Generated event registry
// ignore_for_file: type=lint

import 'package:dddart/dddart.dart';

/// Generated event registry mapping event type names to fromJson factories.
///
/// This map is automatically generated by scanning for @Serializable
/// DomainEvent subclasses. Use this registry with EventBusClient to
/// enable automatic deserialization of distributed events.
final generatedEventRegistry =
    <String, DomainEvent Function(Map<String, dynamic>)>{
  'UserCreatedEvent': UserCreatedEvent.fromJson,
  'OrderPlacedEvent': OrderPlacedEvent.fromJson,
  'PaymentProcessedEvent': PaymentProcessedEvent.fromJson,
};
```

### 5. Use with EventBusClient

```dart
import 'my_events.g.dart'; // Import the generated registry

final client = EventBusClient(
  localEventBus: eventBus,
  serverUrl: 'http://localhost:8080',
  eventRegistry: generatedEventRegistry,
  pollingInterval: const Duration(seconds: 5),
);
```

## How It Works

1. The generator scans all files in your library for classes annotated with `@Serializable`
2. It checks if each annotated class extends `DomainEvent`
3. For each DomainEvent subclass found, it adds an entry to the registry map
4. The registry maps the event's class name (as a string) to its static `fromJson` factory function
5. Events are sorted alphabetically for deterministic output

## Requirements

- Each event class must extend `DomainEvent`
- Each event class must be annotated with `@Serializable`
- Each event class must have a static `fromJson` factory method with signature:
  ```dart
  static EventType fromJson(Map<String, dynamic> json)
  ```

## Benefits

- **Automatic**: No manual registry maintenance
- **Type-safe**: Compile-time checking of event types
- **Deterministic**: Alphabetically sorted for consistent output
- **Maintainable**: Add new events by just annotating them
- **Discoverable**: All distributed events are in one generated map

## Example

See the `example/` directory for a complete working example demonstrating:
- Multiple event types
- Event registry generation
- Integration with EventBusClient

## Troubleshooting

### Events not appearing in registry

- Ensure the event class extends `DomainEvent`
- Ensure the event class has `@Serializable` annotation
- Ensure the event class has a static `fromJson` method
- Run `dart run build_runner clean` and rebuild

### Build errors

- Check that all dependencies are properly configured in `pubspec.yaml`
- Ensure `build.yaml` is properly configured
- Check for syntax errors in your event classes
