name: Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    # Add MongoDB, DynamoDB Local, and MySQL services for integration tests
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      dynamodb:
        image: amazon/dynamodb-local:latest
        ports:
          - 8000:8000
      
      mysql:
        image: mysql:8.0
        ports:
          - 3307:3306
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: test_db
        options: >-
          --health-cmd "mysqladmin ping -h localhost -ptest_password"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s
        # Used by dddart_repository_mysql for integration tests including collection support
    
    strategy:
      matrix:
        package:
          - dddart
          - dddart_serialization
          - dddart_json
          - dddart_rest
          - dddart_config
          - dddart_repository_mongodb
          - dddart_repository_dynamodb
          - dddart_repository_rest
          - dddart_repository_sql
          - dddart_repository_sqlite
          - dddart_repository_mysql
          - dddart_webhooks
          - dddart_webhooks_slack
          - dddart_events_distributed
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: 3.9.4
      
      - name: Cache Dart dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: dart-${{ runner.os }}-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            dart-${{ runner.os }}-
      
      - name: Get dependencies (workspace)
        run: dart pub get
      
      - name: Run code generation for dependencies
        run: |
          # dddart_repository_rest tests depend on dddart_rest generated code
          if [ "${{ matrix.package }}" = "dddart_repository_rest" ]; then
            if [ -f "packages/dddart_rest/pubspec.yaml" ] && grep -q "build_runner" "packages/dddart_rest/pubspec.yaml"; then
              echo "Generating code for dependency: dddart_rest"
              cd packages/dddart_rest
              dart run build_runner build --delete-conflicting-outputs
              cd - > /dev/null
            fi
          fi
      
      - name: Run code generation (if needed)
        run: |
          if grep -q "build_runner" pubspec.yaml; then
            dart run build_runner build --delete-conflicting-outputs
          fi
        working-directory: packages/${{ matrix.package }}
      
      - name: Analyze code
        run: dart analyze --fatal-infos
        working-directory: packages/${{ matrix.package }}
      
      - name: Format check
        run: dart format --output=none --set-exit-if-changed .
        working-directory: packages/${{ matrix.package }}
      
      - name: Wait for MySQL to be ready
        if: matrix.package == 'dddart_repository_mysql'
        run: |
          echo "Waiting for MySQL to be fully ready..."
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -P 3307 -u root -ptest_password --silent; then
              echo "MySQL is ready!"
              # Give it a few more seconds to fully initialize
              sleep 5
              exit 0
            fi
            echo "Waiting for MySQL... ($i/30)"
            sleep 2
          done
          echo "MySQL failed to become ready"
          exit 1
      
      - name: Run tests
        run: |
          # Run all tests including integration tests with service containers
          # MongoDB, DynamoDB, and MySQL services are available in CI
          # Collection tests for MySQL are included (tagged with requires-mysql)
          dart test
        working-directory: packages/${{ matrix.package }}
        env:
          # MySQL connection settings for integration tests
          MYSQL_HOST: 127.0.0.1
          MYSQL_PORT: 3307
          MYSQL_USER: root
          MYSQL_PASSWORD: test_password
          MYSQL_DATABASE: test_db
